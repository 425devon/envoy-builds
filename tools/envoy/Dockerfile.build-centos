ARG ENVOY_BUILD_IMAGE
FROM $ENVOY_BUILD_IMAGE

ARG BUILD_CMD

WORKDIR /envoy-sources

COPY . .

RUN yum install centos-release-scl-rh
RUN yum install devtoolset-4-gcc devtoolset-4-gcc-c++
RUN update-alternatives --install /usr/bin/gcc-4.9 gcc-4.9 /opt/rh/devtoolset-3/root/usr/bin/gcc 10
RUN update-alternatives --install /usr/bin/g++-4.9 g++-4.9 /opt/rh/devtoolset-3/root/usr/bin/g++ 10

RUN bash -c "bazel/setup_clang.sh /opt/llvm"
RUN bash -c "$BUILD_CMD"
